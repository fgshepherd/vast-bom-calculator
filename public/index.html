<!--
  VAST BOM Calculator - A-VAR Edition
  All calculations are performed in-browser. No backend required.
  UI and branding updated to match VAST Configuration Advisor (vast-space-power-based)
  Author: Cascade AI (with user collaboration)
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VAST BOM Calculator | A-VAR Edition</title>
  <meta name="description" content="VAST BOM Calculator by A-VAR - Instantly estimate optimal VAST system configurations for your workloads.">
  <link rel="icon" type="image/x-icon" href="favicon.ico" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --avar-primary-blue: #0d6efd;
      --avar-secondary-accent: #ffc107;
      --avar-dark: #212529;
      --avar-body-text: var(--avar-dark);
      --avar-heading-text: var(--avar-dark);
      --avar-text-light: #fff;
      --avar-text-muted: #6c757d;
      --avar-background-light: #fff;
      --avar-background-medium: #f8f9fa;
      --avar-border-color: #dee2e6;
      --avar-link-color: var(--avar-primary-blue);
      --avar-font-primary: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
      --avar-font-weight-light: 300;
      --avar-font-weight-normal: 400;
      --avar-font-weight-semibold: 600;
      --avar-font-weight-bold: 700;
      --avar-border-radius: 0.25rem;
      --avar-border-radius-lg: 0.3rem;
      --avar-box-shadow: 0 .5rem 1rem rgba(0,0,0,.15);
      --avar-spacing-unit: 1rem;
      --vast-primary: #06D69F;
      --vast-secondary: #1FD9FE;
    }
    html, body {
      margin: 0;
      padding: 0;
      font-family: var(--avar-font-primary);
      background: #e9ecef;
      color: var(--avar-body-text);
      min-height: 100vh;
    }
    .header {
      background: var(--avar-background-medium);
      color: var(--avar-heading-text);
      text-align: center;
      padding: 2.5rem 0 1.5rem 0;
      border-bottom: 1px solid var(--avar-border-color);
      position: relative;
    }
    .logo-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 2.5rem;
      margin-bottom: 1.2rem;
    }
    .logo-row img {
      max-height: 60px;
      background: #fff;
      border-radius: 8px;
      padding: 0.2rem 0.7rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .header-title {
      font-size: 2.2rem;
      font-weight: var(--avar-font-weight-bold);
      margin: 0;
      letter-spacing: 1px;
    }
    .header-subtitle {
      font-size: 1.18rem;
      color: var(--avar-primary-blue);
      margin-top: 0.7rem;
      margin-bottom: 0.8rem;
      font-weight: var(--avar-font-weight-normal);
    }
    .header-directions {
      font-size: 1.02rem;
      color: var(--avar-text-muted);
      margin: 0 auto 1.3rem auto;
      max-width: 600px;
    }
    .container {
      max-width: 700px;
      background: var(--avar-background-light);
      margin: 2.5rem auto;
      border-radius: var(--avar-border-radius-lg);
      box-shadow: var(--avar-box-shadow);
      padding: 2.5rem 2rem 2rem 2rem;
    }
    .footer {
      text-align: center;
      font-size: 0.98rem;
      color: var(--avar-text-muted);
      margin-top: 3.5rem;
      margin-bottom: 1.5rem;
      padding-bottom: 1.5rem;
    }
    .footer a {
      color: var(--avar-link-color);
      text-decoration: none;
    }
    .footer a:hover {
      text-decoration: underline;
    }
    /* Additional cosmetic tweaks for input forms, buttons, etc. can be added here */
  </style>
</head>
<body>
  <div class="header">
    <div class="logo-row">
      <img src="a-var-logo.png" alt="A-VAR Logo" height="45" />
      <img src="vast-logo.png" alt="VAST Logo" height="45" />
    </div>
    <div class="header-title">VAST BOM Calculator</div>
    <div class="header-subtitle">by A-VAR, Your VAST Data Platform Experts</div>
    <div class="header-directions">
      Enter your site and workload details below. Instantly estimate the optimal VAST system configuration for your needs.<br>
      <b>All calculations are performed in your browser. No data is sent to any server.</b>
    </div>
  </div>
  <div class="container">
    <!-- Existing app content starts here -->
    <!-- The BOM Calculator form and summary will be rendered here. -->
    <!--
      All CSS is now in the <style> tag in the <head>.
      No style rules should appear in the body.
    -->
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">
      <!-- Official A-VAR logo -->
      <img src="https://www.a-var.com/wp-content/uploads/2024/06/White-on-Transparent-1-1.png" alt="A-VAR Logo" style="width:54px;height:auto;display:block;margin:0 auto;filter:drop-shadow(0 1px 6px #1e293b88);background:transparent;" />
    </div>
    <h1>VAST BOM Calculator</h1>
    <!-- Brief instructions for user -->
    <div class="subtitle">Enter site and application details below, then click Calculate BOM.</div>
  </div>
  <div class="container">
    <!--
      Main input form for site and application profile details
      Uses modern, accessible layout with clear labels
    -->
    <form class="modern-form" id="bomForm" autocomplete="off">
      <label>
        Site Name
        <input type="text" id="siteName" placeholder="e.g. Project Alpha" maxlength="40" required />
      </label>
      <div class="form-row">
        <label>
          Cabinet Height (U)
          <input type="number" id="cabinetHeight" value="48" min="1" max="60" required />
        </label>
        <label>
          Power Per Cabinet (kW)
          <input type="number" id="powerPerCabinet" value="28.5" min="1" max="100" step="0.1" required />
        </label>
      </div>
      <div class="form-row">
        <label>
          ToR/Mgmt Reservation (U)
          <input type="number" id="torMgmtU" value="5" min="0" max="20" required />
        </label>
        <label>
          ToR/Mgmt Power (kW)
          <input type="number" id="torMgmtKW" value="2.0" min="0" max="10" step="0.1" required />
        </label>
        <label>
          Bottom Reservation (U)
          <input type="number" id="bottomU" value="2" min="0" max="20" required />
        </label>
      </div>
      <!-- Clarify that capacity is in TB -->
<div style="margin-top:1.7rem; margin-bottom:0.5rem; font-size:1.1rem; font-weight:700; color:var(--av-blue-dark)">Application Profiles (Capacity in TB)</div>
      <div class="profile-list" id="profileList"></div>
      <button type="button" class="secondary-btn" id="addProfileBtn">+ Add Application</button>
      <button type="submit" class="primary-btn" id="calcBtn">Calculate BOM</button>
      <div id="errorMsg" class="error-msg" style="display:none"></div>
    </form>
    <!--
      BOM summary and per-app cards appear here after calculation
    -->
    <div id="bomSummary" class="bom-summary-cards" style="display:none"></div>
  </div>
  <div class="footer">
    &copy; <span id="year"></span> A-VAR, Inc. | VAST BOM Calculator. All calculations run locally in your browser.
  </div>
  <script>
    // --- D-Box Capacities Table (truncated for brevity, use full data in production) ---
    // For demo, only a subset is shown. Replace with full data for real use.
    const D_CAPACITIES = [
      { dbox_count: 1, usable_tb: 982.67 },
      { dbox_count: 2, usable_tb: 2210.81 },
      { dbox_count: 3, usable_tb: 3447.19 },
      { dbox_count: 4, usable_tb: 4678.98 },
      { dbox_count: 5, usable_tb: 5909.54 },
      { dbox_count: 6, usable_tb: 7139.3 },
      { dbox_count: 7, usable_tb: 8368.93 },
      { dbox_count: 8, usable_tb: 9564.49 },
      { dbox_count: 9, usable_tb: 10760.05 },
      { dbox_count: 10, usable_tb: 11955.61 },
      { dbox_count: 11, usable_tb: 13151.17 },
      { dbox_count: 12, usable_tb: 14346.73 },
      { dbox_count: 13, usable_tb: 15542.29 },
      { dbox_count: 14, usable_tb: 16737.85 },
      { dbox_count: 15, usable_tb: 17933.41 },
      { dbox_count: 16, usable_tb: 19128.98 },
      { dbox_count: 17, usable_tb: 20324.54 },
      { dbox_count: 18, usable_tb: 21520.1 },
      { dbox_count: 19, usable_tb: 22715.66 },
      { dbox_count: 20, usable_tb: 23911.22 },
      { dbox_count: 21, usable_tb: 25106.78 },
      { dbox_count: 22, usable_tb: 26302.34 },
      { dbox_count: 23, usable_tb: 27497.9 },
      { dbox_count: 24, usable_tb: 28693.46 },
      { dbox_count: 25, usable_tb: 29889.02 },
      { dbox_count: 26, usable_tb: 31084.58 },
      { dbox_count: 27, usable_tb: 32280.14 },
      { dbox_count: 28, usable_tb: 33475.7 },
      { dbox_count: 29, usable_tb: 34671.26 },
      { dbox_count: 30, usable_tb: 35866.82 },
      // ... (add the full table here for production use)
    ];

    // --- Constants (commented for clarity) ---
    const CBOX_U = 1, CBOX_KW = 0.5;
    const DBOX_U = 1, DBOX_KW = 0.75;
    const SWITCH_U = 2, SWITCH_KW = 0.3;
    const MIN_CBOXES = 2;
    const PERF_CBOX = { NFS_READ: 29, NFS_WRITE: 6, S3_READ: 13.2, S3_WRITE: 5 };
    const PERF_DBOX = { NFS_READ: 51, NFS_WRITE: 12.7, S3_READ: 51, S3_WRITE: 12.7 };
    const METRIC_MAP = {
      'NFS Read': 'NFS_READ',
      'NFS Write': 'NFS_WRITE',
      'S3 Read': 'S3_READ',
      'S3 Write': 'S3_WRITE'
    };

    // --- Utility Functions ---
    function findDBoxConfig(targetTB) {
      // Find the smallest dbox config that meets or exceeds targetTB
      for (const config of D_CAPACITIES) {
        if (config.usable_tb >= targetTB) return config;
      }
      // If none found, return the largest available
      return D_CAPACITIES[D_CAPACITIES.length - 1];
    }

    function calculateCBoxes(dBoxCount, optimizationGoal, performanceMetric) {
      // For this UI, always use SPECIFIC_METRIC (from first app)
      const metricKey = METRIC_MAP[performanceMetric] || 'NFS_READ';
      // C-Box bottleneck: total D-Box perf / C-Box perf
      const totalDPerf = dBoxCount * PERF_DBOX[metricKey];
      let rawCBoxCount = Math.ceil(totalDPerf / PERF_CBOX[metricKey]);
      if (rawCBoxCount < MIN_CBOXES) rawCBoxCount = MIN_CBOXES;
      return rawCBoxCount;
    }

    function calculateBOM(site, apps) {
      // 1. Total required capacity
      const totalCapacityTB = apps.reduce((sum, app) => sum + Number(app.capacity), 0);
      // 2. Find D-Box config
      const dboxConfig = findDBoxConfig(totalCapacityTB);
      const dBoxCount = dboxConfig.dbox_count;
      // 3. Perf priority (from first app)
      const perfPriority = apps.length > 0 ? apps[0].priority : 'NFS Read';
      // 4. C-Boxes
      const cBoxCount = calculateCBoxes(dBoxCount, 'SPECIFIC_METRIC', perfPriority);
      // 5. Cabinets
      const cabinetHeight = Number(site.cabinetHeight) || 48;
      const powerPerCabinet = Number(site.powerPerCabinet) || 28.5;
      const torMgmtU = Number(site.torMgmtU) || 5;
      const torMgmtKW = Number(site.torMgmtKW) || 2.0;
      const bottomU = Number(site.bottomU) || 2;
      const vastIntU = 4, vastIntKW = 0.6;
      const totalU = dBoxCount * DBOX_U + cBoxCount * CBOX_U;
      const totalKW = dBoxCount * DBOX_KW + cBoxCount * CBOX_KW;
      const usableU = cabinetHeight - torMgmtU - vastIntU - bottomU;
      const usableKW = powerPerCabinet - torMgmtKW - vastIntKW;
      const cabinetCountByU = Math.ceil(totalU / usableU);
      const cabinetCountByKW = Math.ceil(totalKW / usableKW);
      const cabinetCount = Math.max(cabinetCountByU, cabinetCountByKW, 1);
      // Cables
      const dBoxCables = dBoxCount * 4;
      const cBoxCables = cBoxCount * 2;
      return {
        dBoxCount,
        cBoxCount,
        cabinetCount,
        torMgmtSwitches: cabinetCount,
        vastInterconnectSwitches: cabinetCount * 2,
        dBoxCables,
        cBoxCables,
        totalCables: dBoxCables + cBoxCables,
        bottomReserved: cabinetCount,
        siteName: site.siteName,
        totalCapacityTB,
        perfPriority,
        notes: 'Calculated in-browser using A-VAR logic.'
      };
    }

    // --- UI Logic ---
    const profileList = document.getElementById('profileList');
    const addProfileBtn = document.getElementById('addProfileBtn');
    const bomForm = document.getElementById('bomForm');
    const errorMsg = document.getElementById('errorMsg');
    const bomSummary = document.getElementById('bomSummary');
    const yearSpan = document.getElementById('year');
    yearSpan.textContent = new Date().getFullYear();

    let appProfiles = [
      { appName: '', capacity: 100, priority: 'NFS Read' }
    ];

    function renderProfiles() {
      profileList.innerHTML = '';
      appProfiles.forEach((profile, idx) => {
        const row = document.createElement('div');
        row.className = 'profile-row';
        row.innerHTML = `
          <input type="text" placeholder="App Name" value="${profile.appName}" maxlength="30" onchange="appProfiles[${idx}].appName=this.value" />
          <input type="number" min="100" step="1" placeholder="Capacity (TB)" value="${profile.capacity}" onchange="appProfiles[${idx}].capacity=this.value" />
          <select onchange="appProfiles[${idx}].priority=this.value">
            <option${profile.priority==='NFS Read'?' selected':''}>NFS Read</option>
            <option${profile.priority==='NFS Write'?' selected':''}>NFS Write</option>
            <option${profile.priority==='S3 Read'?' selected':''}>S3 Read</option>
            <option${profile.priority==='S3 Write'?' selected':''}>S3 Write</option>
          </select>
          <button type="button" class="remove-btn" onclick="removeProfile(${idx})">&minus;</button>
        `;
        profileList.appendChild(row);
      });
      if (appProfiles.length === 0) {
        const emptyMsg = document.createElement('div');
        emptyMsg.style.color = 'var(--av-gray)';
        emptyMsg.style.marginBottom = '1rem';
        emptyMsg.textContent = 'Add at least one application profile.';
        profileList.appendChild(emptyMsg);
      }
    }

    window.removeProfile = function(idx) {
      appProfiles.splice(idx, 1);
      renderProfiles();
    };

    addProfileBtn.onclick = function(e) {
      e.preventDefault();
      appProfiles.push({ appName: '', capacity: 100, priority: 'NFS Read' });
      renderProfiles();
    };

    renderProfiles();

    bomForm.onsubmit = function(e) {
      e.preventDefault();
      errorMsg.style.display = 'none';
      // Always update appProfiles from the DOM before calculation (in case of any missed changes)
      const profileRows = document.querySelectorAll('.profile-row');
      appProfiles = Array.from(profileRows).map(row => {
        const inputs = row.querySelectorAll('input,select');
        return {
          appName: inputs[0].value.trim(),
          capacity: Number(inputs[1].value),
          priority: inputs[2].value
        };
      });
      // Validate site fields
      const site = {
        siteName: document.getElementById('siteName').value.trim(),
        cabinetHeight: Number(document.getElementById('cabinetHeight').value),
        powerPerCabinet: Number(document.getElementById('powerPerCabinet').value),
        torMgmtU: Number(document.getElementById('torMgmtU').value),
        torMgmtKW: Number(document.getElementById('torMgmtKW').value),
        bottomU: Number(document.getElementById('bottomU').value)
      };
      if (!site.siteName) {
        showError('Please enter a site name.');
        return;
      }
      // Validate app profiles
      for (const p of appProfiles) {
        if (!p.capacity || isNaN(Number(p.capacity)) || Number(p.capacity) < 100) {
          showError('Each application capacity must be a number of at least 100 TB.');
          return;
        }
      }
      // Convert all capacities to numbers
      const sanitizedProfiles = appProfiles.map(p => ({ ...p, capacity: Number(p.capacity) }));
      // Pass the real appProfiles for card rendering
      window.appProfiles = sanitizedProfiles;
      const bom = calculateBOM(site, sanitizedProfiles);
      showBomSummary(bom);
    };


    function showError(msg) {
      errorMsg.textContent = msg;
      errorMsg.style.display = '';
    }

    // Render the new card-based BOM summary and per-app stats
    // Render the new card-based BOM summary and per-app stats
    // Render a simple section for each app, then a site BOM summary table
    function showBomSummary(bom) {
      let html = '';
      // Show each application profile as a section
      if (Array.isArray(window.appProfiles) && window.appProfiles.length > 0) {
        html += `<div style='margin-bottom:2.2rem;'>`;
        window.appProfiles.forEach((profile, idx) => {
          html += `<section style='background:var(--av-gray-light);border-radius:8px;padding:1rem 1.3rem 0.8rem 1.3rem;margin-bottom:1.1rem;box-shadow:0 1px 4px rgba(30,41,59,0.07);'>
            <h3 style='margin:0 0 0.4rem 0;font-size:1.13rem;color:var(--av-blue-dark);font-weight:700;'>App ${profile.appName ? `: ${profile.appName}` : `#${idx+1}`}</h3>
            <div><strong>Capacity:</strong> ${profile.capacity} TB</div>
            <div><strong>Priority:</strong> ${profile.priority}</div>
          </section>`;
        });
        html += `</div>`;
      }
      // Site BOM summary table
      html += `<div style='margin-bottom:1.3rem;'>
        <h2 style='color:var(--av-blue-dark);margin-bottom:0.7rem;'>Site BOM Summary</h2>
        <table class='bom-table' style='background:var(--av-white);'>
          <thead>
            <tr><th>Component</th><th>Quantity</th><th>Notes</th></tr>
          </thead>
          <tbody>
            <tr><td>D-Box</td><td>${bom.dBoxCount}</td><td>1U, 0.75 kW each</td></tr>
            <tr><td>C-Box</td><td>${bom.cBoxCount}</td><td>1U, 0.5 kW each</td></tr>
            <tr><td>Cabinets</td><td>${bom.cabinetCount}</td><td>Min. by U/kW</td></tr>
            <tr><td>ToR/Mgmt Switches</td><td>${bom.torMgmtSwitches}</td><td>1 per cab</td></tr>
            <tr><td>VAST Interconnect</td><td>${bom.vastInterconnectSwitches}</td><td>2 per cab, 4U/cab, 0.3 kW each</td></tr>
            <tr><td>D-Box Cables</td><td>${bom.dBoxCables}</td><td>4 per D-Box</td></tr>
            <tr><td>C-Box Cables</td><td>${bom.cBoxCables}</td><td>2 per C-Box</td></tr>
            <tr><td>Total Cables</td><td>${bom.totalCables}</td><td></td></tr>
            <tr><td>Bottom Reserved (2U)</td><td>${bom.bottomReserved}</td><td>Per cabinet</td></tr>
          </tbody>
        </table>
        <div style='text-align:center; margin:1.2rem 0 0.7rem 0; color:var(--av-blue-dark); font-weight:700; font-size:1.09rem;'>
          Site: ${bom.siteName}<br/>Total Capacity: ${bom.totalCapacityTB.toLocaleString()} TB<br/>Performance Priority: ${bom.perfPriority}
        </div>
      </div>`;
      html += `<div style='text-align:center; margin-top:1.6rem;'>
        <button class='primary-btn' onclick='window.location.reload()'>Start New Site</button>
      </div>`;
      bomSummary.innerHTML = html;
      bomSummary.style.display = '';
      bomForm.style.display = 'none';
    }
    // End of showBomSummary
    // ... other JS code ...
  </script>
  <!-- End of main JS logic -->

  </div> <!-- Close main container -->
  <div class="footer">
    &copy; 2024 A-VAR, Inc. | VAST Data Platform Solutions<br>
    <a href="mailto:info@a-var.com">info@a-var.com</a> | <a href="https://a-var.com" target="_blank">a-var.com</a>
    <br>Need help or a custom quote? Contact us anytime.
  </div>
</body>
</html>
